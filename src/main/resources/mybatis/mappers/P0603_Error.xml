<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="proj.spring.mes.dao.mapper.P0603_ErrorMapperDAO">
	<!-- SQL문 작성 영역 : 여기도 담당자 입력 있던가 자동 조회였던가 -->
	<!-- 일단 확실한 건 검사 id로 담당자 조회였던 걸로 기억함 -->
	
	<!-- 전체 조회 -->
	<select id = "selectError" resultType = "P0603_ErrorDTO" parameterType="P0401_StockDTO">
		select
			d.defect_reason_id, d.defect_reason, d.defect_exhaust,
			d.inspection_result_id, s.stock_id, it.item_id, it.item_name
		from v3_defect d
			left outer join v3_inspection_result i
				on d.inspection_result_id = i.inspection_result_id
			left outer join v3_worker w
		        on i.worker_id = w.worker_id
		    left outer join v3_stock s
		        on i.stock_id = s.stock_id
		    left outer join v3_item it
		        on s.item_id = it.item_id
		<where>
			<if test="inspection_result_id != null and inspection_result_id != ''">
				and lower(d.inspection_result_id) like lower('%' || #{inspection_result_id} || '%')
			</if>
	        <if test="fromDate != null and fromDate != '' and toDate != null and toDate != ''">
	            and i.inspection_result_date BETWEEN #{fromDate} AND #{toDate}
	        </if>
			<if test="item_name != null and item_name != ''">
				and lower(it.item_name) like lower('%' || #{item_name} || '%')
			</if>
		</where>
		order by d.defect_reason_id
	</select>

	
	<!-- 단일 조회 -->
	<select id = "selectOneError" resultType = "P0603_ErrorDTO">
		select
			d.defect_reason_id, d.defect_reason, d.defect_exhaust,
			d.inspection_result_id, i.inspection_result_date, i.stock_id
		from v3_defect d left outer join v3_inspection_result i
			on d.inspection_result_id = i.inspection_result_id 
		where d.defect_reason_id = {#parameter}
		order by defect_reason_id
	</select>
	
	<!-- 수정 -->
	<update id = "updateError" parameterType = "P0603_ErrorDTO">
		update v3_defect
		set defect_reason = #{defect_reason},
			defect_exhaust = #{defect_exhaust},
			inspection_result_id = #{inspection_result_id}
		where defect_reason_id = #{defect_reason_id}
	</update>
	
	<!-- 삭제 -->
<!-- 	<delete id = "deleteError" parameterType = "P0603_ErrorDTO"> -->
<!-- 		delete from v3_defect -->
<!-- 		where defect_reason_id = #{defect_reason_id} -->
<!-- 	</delete> -->
	<delete id = "deleteErrors" parameterType = "java.util.List">
		delete from v3_defect
		where defect_reason_id in
		<foreach item="id" collection="list" open="(" separator="," close=")">
			#{id}
		</foreach>
	</delete>
	
	<!-- 삽입 -->
	<insert id = "insertError" parameterType = "P0603_ErrorDTO">
		<selectKey keyProperty="defect_reason_id" resultType="string" order="BEFORE">
		  select 'N' || TO_CHAR(SYSDATE, 'YYMMDD') || LPAD(defect_reason_id_seq.NEXTVAL, 2, '0')
		  from dual
		</selectKey>
		
		insert into v3_defect (
			defect_reason_id, defect_reason, defect_exhaust, inspection_result_id
		)
		values (
			#{defect_reason_id}, #{defect_reason}, #{defect_exhaust}, #{inspection_result_id}
		)
	</insert>
</mapper>