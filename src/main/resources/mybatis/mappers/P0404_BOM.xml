<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="proj.spring.mes.dao.mapper.P0404_BomMapperDAO">
	<!-- SQL문 작성 영역 -->
	<!-- 지금 삭제 제외한 코드들은 전부 한 번씩 고민해봐야 함. 지금은 임의 복붙한 것. -->
	
	<!-- 전체 조회 : 이쪽은 ㅇㅋ. -->
	<select id = "selectBOM" resultType = "P0404_BOMDTO" parameterType="P0404_BOMDTO">
		select
		    b.bom_id, b.bom_amount, b.item_id,
		    im.item_div, im.item_name,
		    ip.item_div, ip.item_name
		from v3_bom b
		left join v3_item im
		    on im.item_id = 
		    	ltrim(SUBSTR(b.bom_id, 1, LENGTH(b.bom_id) - 2), 'F')
		left join v3_item ip
			on ip.item_id = b.item_id
		
		<where>
			<if test="bom_id != null and bom_id != ''">
				and lower(b.bom_id) like lower('%' || #{bom_id} || '%')
			</if>
			<if test="item_div != null and item_div != ''">
				and im.item_div = #{item_div}
			</if>
			<if test="item_id != null and item_id != ''">
				and lower(b.item_id) like lower('%' || #{item_id} || '%')
			</if>					
		</where>
		
		order by b.item_id
	</select>

	
	<!-- 단일 조회 -->
	<select id = "selectOneBOM" resultType = "P0404_BOMDTO">
	    select
	        b.bom_id, 
	        b.bom_amount, 
	        b.item_id AS item_id, 
	        i_material.item_id AS material_item_id,
	        i_material.item_name AS material_item_name,
	        i_material.item_div AS material_item_div,
	        i_product.item_name AS product_item_name
	    from v3_bom b
	        left join v3_item i_product
	            on b.item_id = i_product.item_id
	        left join v3_item i_material
	            on i_material.item_id = 
	                ltrim(substr(b.bom_id, 1, LENGTH(b.bom_id) - 2), 'F')
	    where b.bom_id = #{_parameter}
	</select>
	
	<!-- 조회 : 품목 id(완제) 기준 조회. 혹시 쓸 일 있을까봐. -->
	<select id = "selectBOMByItem" resultType = "P0404_BOMDTO" parameterType="string">
	    select
	        b.bom_id, 
	        b.bom_amount, 
	        b.item_id as item_id,
	        i_material.item_id as material_item_id,
	        i_material.item_name as material_item_name, 
	        i_material.item_div as material_item_div,
	        i_product.item_name as product_item_name
	    from v3_bom b
	        left join V3_ITEM i_product
	            on b.item_id = i_product.item_id
	    left join V3_ITEM i_material
	        on i_material.item_id = 
	            ltrim(substr(b.bom_id, 1, length(b.bom_id) - 2), 'F')
	    where b.item_id = #{bom_id}
	    order by b.bom_id
	</select>
	
	<!-- 조회 : 완제 기준 상세 목록 표시 -->
	<select id = "selectBOMsByItem" resultType = "P0404_BOMDTO" parameterType="String">
		select
			 b.bom_id,
			 b.bom_amount,
			 b.item_id as item_id,
			 i_material.item_id as material_item_id,
			 i_material.item_name as material_item_name,
			 i_material.item_div as material_item_div,
			 i_product.item_name as product_item_name
		from v3_bom b
			 left join v3_item i_product
			 	 on b.item_id = i_product.item_id
			 left join v3_item i_material
			 	 on i_material.item_id =
			 	 	 ltrim(substr(b.bom_id, 1, length(b.bom_id) - 2), 'F')
		where b.item_id = #{item_id}
		order by b.bom_id
	</select>
	
	<!-- 조회 : 품목 기준 전체 조회 -->
	<select id = "selectOneBOMItemF" resultType = "P0404_BOMDTO">
		select distinct
			ip.item_id as product_item_id,
			ip.item_name as product_item_name
		from v3_bom b
		left outer join v3_item ip
			on b.item_id = ip.item_id
		left outer join v3_item im
			on im.item_id = ltrim(substr(b.bom_id, 1, length(b.bom_id) - 2), 'F')
		<where>
			<if test="material_item_name != null and material_item_name != ''">
				and lower(im.item_name) like lower('%' || #{material_item_name} || '%')
			</if>
			<if test="product_item_name != null and product_item_name != ''">
				and lower(ip.item_name) like lower('%' || #{product_item_name} || '%')
			</if>
		</where>
		order by product_item_id
	</select>
	
	<!-- 조회 : 품목 고르기용 1(완제) -->
	<select id = "selectBOMPro" resultType = "P0404_BOMDTO">
		select
			item_id as pro_item_id, item_name as pro_item_name
		from v3_item
		where item_div = '완제품'
	</select>
	
	<!-- 조회 : 품목 고르기용 2(재료) -->
	<select id = "selectOneBOMItemM" resultType = "P0404_BOMDTO">
		select
			item_id as material_item_id, item_name as material_item_name,
			item_div as material_item_div
		from v3_item
		where item_div in ('도서', '포장지')
	</select>
	
	<!-- 수정 : 여기도 재료 id를 이용해 작성하는 거니까 update에 bom id도 포함되어야 함-->
	<update id = "updateBOM" parameterType = "P0404_BOMDTO">
		update v3_bom
		set bom_amount = #{bom_amount}
		where bom_id = #{bom_id}
	</update>
	
	<!-- 삭제 -->
<!-- 	<delete id = "deleteBOM" parameterType = "P0404_BOMDTO"> -->
<!-- 		delete from v3_bom -->
<!-- 		where bom_id = #{bom_id} -->
<!-- 	</delete> -->
	
	<delete id = "deleteBOMs" parameterType = "java.util.List">
		delete from v3_bom
		where item_id in
		<foreach item="id" collection="list" open="(" separator="," close=")">
			#{id}
		</foreach>
	</delete>
	
	<!-- 삽입 : 여기를 to_char(sysdate)가 아니라 입력받은 재료 id값 일부가 들어가도록 조정해야 함-->
	<insert id="insertBOM" parameterType="P0404_BOMDTO">
	    <selectKey keyProperty="bom_id" resultType="string" order="BEFORE">
	        select
	            'F' || #{material_item_id} || LPAD(BOM_ID_SEQ.NEXTVAL, 2, '0')
	        from dual
	    </selectKey>
	    
	    insert into v3_bom (
	        bom_id,           bom_amount,
	        item_id           )
	    values (
	        #{bom_id},          #{bom_amount},
	        #{product_item_id}  )
	</insert>
	
	<!-- 통합 구현용 코드들 -->
	
	<update id = "updateBOMByMap" parameterType = "java.util.Map">
		update v3_bom
		set bom_amount = #{bom_amount}
		where bom_id = #{bom_id}
	</update>
	
	<delete id = "deleteBOMByIds" parameterType = "java.util.List">
		delete from v3_bom
		where bom_id in
		<foreach item="id" collection="list" open="(" separator="," close=")">
			#{id}
		</foreach>
	</delete>
	
	<insert id="insertBOMByMap" parameterType="java.util.Map">
		<selectKey keyProperty="bom_id" resultType="string" order="BEFORE">
			select
				'F' || #{material_item_id} || LPAD(BOM_ID_SEQ.NEXTVAL, 2, '0')
			from dual
		</selectKey>
		
		insert into v3_bom (
			bom_id, bom_amount, item_id
		)
		values (
			#{bom_id}, #{bom_amount}, #{product_item_id}
		)
	</insert>

</mapper>