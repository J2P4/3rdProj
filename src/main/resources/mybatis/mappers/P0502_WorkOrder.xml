<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="proj.spring.mes.dao.mapper.P0502_WorkOrderMapperDAO">
	<!-- 전체 조회 -->
<!-- 	<select id = "selectWO" resultType = "P0502_WorkOrderDTO" parameterType = "P0502_WorkOrderDTO"> -->
<!-- 		select -->
<!-- 			wo.work_order_id, wo.work_order_date, wo.work_order_num, -->
<!-- 			wo.work_order_fin, wo.cp_id, wo.worker_id, w.worker_name -->
<!-- 		from v3_work_order wo -->
<!-- 		left outer join v3_cp c -->
<!-- 			on wo.cp_id = c.cp_id -->
<!-- 		left outer join v3_worker w -->
<!-- 			on wo.worker_id = w.worker_id -->
<!-- 		<where> -->
<!-- 			<if test = "cp_id != null and cp_id != ''"> -->
<!-- 				and wo.cp_id = #{cp_id} -->
<!-- 			</if> -->
<!-- 			<if test = "worker_id != null and worker_id != ''"> -->
<!-- 				and wo.worker_id = #{worker_id} -->
<!-- 			</if> -->
<!-- 			<if test = "fromDate != null and fromDate != '' and toDate != null and toDate != ''"> -->
<!-- 				and wo.work_order_date between #{fromDate} and #{toDate} -->
<!-- 			</if> -->
<!-- 		</where> -->
<!-- 	</select> -->
	
	<!-- 전체 조회 : 페이지 넣는 기준 -->
	<select id="selectWO" resultType="P0502_WorkOrderDTO">
	    <bind name="startRow" value="offset + 1"/>
	    <bind name="endRow"   value="offset + limit"/>
		SELECT *
		FROM (
			SELECT t.*, ROWNUM rn
			FROM (
				select
				    wo.work_order_id, wo.work_order_date, wo.work_order_num,
				    wo.work_order_fin, wo.cp_id, wo.worker_id, w.worker_name,
				    c.item_id
				from v3_work_order wo
				left outer join v3_cp c
				    on wo.cp_id = c.cp_id
				left outer join v3_worker w
				    on wo.worker_id = w.worker_id
				<where>
					<if test = "filter.cp_id != null and filter.cp_id != ''">
						and wo.cp_id = #{filter.cp_id}
					</if>
					<if test = "filter.worker_id != null and filter.worker_id != ''">
						and wo.worker_id = #{filter.worker_id}
					</if>
					<if test = "filter.fromDate != null and filter.toDate != null">
						and wo.work_order_date between #{filter.fromDate} and #{filter.toDate}
					</if>
				</where>
			) t
			<![CDATA[
			WHERE ROWNUM <= #{endRow}
			]]>
		)
		<![CDATA[
		WHERE rn >= #{startRow}
		]]>
	</select>

	<!-- 총 레코드 수 -->
	<select id="selectWOCount" parameterType="map" resultType="long">
		SELECT COUNT(*)
		from v3_work_order wo
		left outer join v3_cp c
		    on wo.cp_id = c.cp_id
		left outer join v3_worker w
		    on wo.worker_id = w.worker_id
		<where>
			<if test = "filter.cp_id != null and filter.cp_id != ''">
				and wo.cp_id = #{filter.cp_id}
			</if>
			<if test = "filter.worker_id != null and filter.worker_id != ''">
				and wo.worker_id = #{filter.worker_id}
			</if>
			<if test = "filter.fromDate != null and filter.toDate != null">
				and wo.work_order_date between #{filter.fromDate} and #{filter.toDate}
			</if>
		</where>
	</select>
	
	<!-- 단일 조회 -->
	<select id = "selectOneWO" resultType = "P0502_WorkOrderDTO">
		select
			wo.work_order_id, wo.work_order_date, wo.work_order_num,
			wo.work_order_fin, wo.cp_id, wo.worker_id, w.worker_name
		from v3_work_order wo
		left outer join v3_cp c
			on wo.cp_id = c.cp_id
		left outer join v3_worker w
			on wo.worker_id = w.worker_id
		<where>
			wo.work_order_id = #{work_order_id}
		</where>
	</select>
	
	<!-- 조회 : 작업 지시에 해당하는 bom 조회 -->
	<select id = "selectBOM" resultType = "P0502_WorkOrderDTO">
		select
			bom_id, bom_amount, item_id
		from v3_bom
		where item_id = #{item_id}
	</select>
	
	<!-- 조회 : 작업 지시에 해당하는 공정 조회 -->
	<!-- 품목별로 공정 차이 안 두기로 했으므로, 그냥 전체 조회로 해도 됨 -->
	<select id = "selectPro" resultType = "P0502_WorkOrderDTO">
		select
			process_id, process_name, process_img,
			process_info, process_seq
		from v3_process
	</select>
	
	<!-- 조회 : 작업자 목록 -->
	<select id="selectAllWorker" resultType="P0502_WorkOrderDTO">
		SELECT
			worker_id,
			worker_name
		FROM v3_worker
		ORDER BY worker_id
	</select>
	<!-- 삽입 -->
	<insert id = "insertWO" parameterType = "P0502_WorkOrderDTO">
		<selectKey keyProperty="work_order_id" resultType="string" order="BEFORE">
		  select 'I' || TO_CHAR(SYSDATE, 'YYMMDD') || LPAD(inspection_result_id_seq.NEXTVAL, 2, '0')
		  from dual
		</selectKey>
		INSERT INTO V3_WORK_ORDER
		    (
		        WORK_ORDER_ID, WORK_ORDER_DATE, WORK_ORDER_NUM, WORK_ORDER_FIN,
		        CP_ID, WORKER_ID
		    )
		VALUES
			(
				#{WORK_ORDER_ID}, #{WORK_ORDER_DATE}, #{WORK_ORDER_NUM},
				#{WORK_ORDER_FIN}, #{CP_ID}, #{WORKER_ID}
			)
	</insert>
	
	<!-- 삭제 -->
	<delete id = "deleteWOs" parameterType = "java.util.List">
		delete from v3_work_order
		where work_order_id in
		<foreach item="id" collection="list" open="(" separator="," close=")">
			#{id}
		</foreach>
	</delete>
	
	<!-- 수정 : 기본 수정 -->
	<update id = "updateWO" parameterType = "P0502_WorkOrderDTO">
		update v3_work_order
		set work_order_date = #{work_order_date},
			work_order_num = #{work_order_num},
			worker_id = #{worker_id}
		where work_order_id = #{work_order_id}
	</update>
	
	<!-- 수정 : 생산 수량만 -->
	<update id = "updateWOFin" parameterType = "P0502_WorkOrderDTO">
		update v3_work_order
		set work_order_fin = #{work_order_fin}
		where work_order_id = #{work_order_id}
	</update>
	
</mapper>