<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="proj.spring.mes.dao.mapper.ItemMapperDAO">

  <select id="selectItemList" resultType="proj.spring.mes.dto.ItemDTO">
    <![CDATA[
    SELECT
      item_id,
      item_price,
      item_div,
      item_name,
      item_unit
    FROM V3_item
    ORDER BY item_name ASC
    ]]>
  </select>

  <select id="selectItemListPage" resultType="proj.spring.mes.dto.ItemDTO">
    <bind name="startRow" value="offset + 1"/>
    <bind name="endRow"   value="offset + limit"/>
    <![CDATA[
    SELECT *
    FROM (
      SELECT t.*, ROWNUM rn
      FROM (
        SELECT
          item_id,
          item_price,
          item_div,
          item_name,
          item_unit
        FROM V3_item
        ORDER BY item_name ASC
      ) t
      WHERE ROWNUM <= #{endRow}
    )
    WHERE rn >= #{startRow}
    ]]>
  </select>

  <select id="selectItemCount" resultType="long">
    <![CDATA[
    SELECT COUNT(*) FROM V3_item
    ]]>
  </select>

  <select id="selectItemOne" parameterType="string" resultType="proj.spring.mes.dto.ItemDTO">
    <![CDATA[
	SELECT
	  COALESCE(c.client_id, ci.client_id) AS client_id,  -- 조인 안 된 쪽도 아이디 보이게
	  c.client_name,
	  COALESCE(i.item_id, ci.item_id)     AS item_id,
	  i.item_name,
	  i.item_div,
	  i.item_price,
	  i.item_unit
	FROM v3_client c
	FULL OUTER JOIN v3_client_items ci
	  ON ci.client_id = c.client_id
	FULL OUTER JOIN v3_item i
	  ON i.item_id = ci.item_id 

    WHERE i.item_id = #{itemId}
    ]]>
  </select>
  
  <delete id="deleteItems" parameterType="java.util.List">
  <![CDATA[
  DELETE FROM V3_item
  WHERE item_id IN
  ]]>
  <foreach item="id" collection="list" open="(" separator="," close=")">
    #{id}
  </foreach>
</delete>
  
  
  
  
  <select id="selectClientsByItemId" parameterType="string" resultType="map">
  SELECT
    c.client_id,
    c.client_name
  FROM v3_client_items ci
  JOIN v3_client c
    ON c.client_id = ci.client_id
  WHERE ci.item_id = #{itemId}
  ORDER BY c.client_id
</select>
  
  
  
  

<insert id="insertItem" parameterType="proj.spring.mes.dto.ItemDTO">
    <selectKey keyProperty="item_id" resultType="string" order="BEFORE">
      SELECT 'I' || LPAD(V3_ITEM_SEQ.NEXTVAL, 4, '0') FROM DUAL
      </selectKey>
    
    INSERT INTO V3_item (
      item_id, item_price, item_div, item_name, item_unit
    ) VALUES (
      #{item_id}, #{item_price}, #{item_div}, #{item_name}, #{item_unit}
    )
  </insert>

  <update id="updateItem" parameterType="proj.spring.mes.dto.ItemDTO">
    <![CDATA[
    UPDATE V3_item
    SET
      item_price = #{item_price},
      item_div   = #{item_div},
      item_name  = #{item_name},
      item_unit  = #{item_unit}
   WHERE item_id = #{item_id}
    ]]>
  </update>

  <delete id="deleteItem" parameterType="string">
    <![CDATA[
    DELETE FROM V3_item
    WHERE item_id = #{itemId}
    ]]>
  </delete>
  
  
  <select id="clientlist" resultType="map">
  SELECT
    client_id,
    client_name
  FROM V3_client
  ORDER BY client_id
</select>
  
  
  

</mapper>